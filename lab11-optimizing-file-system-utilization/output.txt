ðŸ§ª Lab 11: Optimizing File System Utilization
Environment: CentOS/RHEL 8/9 style lab machine (Cloud)
Shell Prompt: -bash-4.2$

========================================
Task 1.1: Understanding File System Mount Options
========================================

-bash-4.2$ mount | grep -E "(ext4|xfs|btrfs)"
/dev/nvme0n1p1 on / type xfs (rw,relatime,attr2,inode64,noquota)
tmpfs on /dev/shm type tmpfs (rw,nosuid,nodev)
tmpfs on /run type tmpfs (rw,nosuid,nodev,mode=755)

-bash-4.2$ cat /proc/mounts | grep -E "(ext4|xfs|btrfs)"
/dev/nvme0n1p1 / xfs rw,relatime,attr2,inode64,noquota 0 0

-bash-4.2$ df -h
Filesystem      Size  Used Avail Use% Mounted on
/dev/nvme0n1p1   32G  4.2G   28G  14% /
devtmpfs        1.8G     0  1.8G   0% /dev
tmpfs           1.9G     0  1.9G   0% /dev/shm
tmpfs           1.9G   17M  1.9G   1% /run
tmpfs           1.9G     0  1.9G   0% /sys/fs/cgroup
tmpfs           373M  4.0K  373M   1% /run/user/1000

========================================
Task 1.1: Create a test directory and examine default atime behavior
========================================

-bash-4.2$ sudo mkdir -p /opt/fstest
-bash-4.2$ cd /opt/fstest

-bash-4.2$ echo "Test file for access time monitoring" > testfile.txt

-bash-4.2$ stat testfile.txt
  File: â€˜testfile.txtâ€™
  Size: 36        	Blocks: 8          IO Block: 4096   regular file
Device: 103:1	Inode: 5244512     Links: 1
Access: (0644/-rw-r--r--)  Uid: ( 1000/ centos)   Gid: ( 1000/ centos)
Access: 2026-08-19 12:46:20.000000000 +0000
Modify: 2026-08-19 12:46:20.000000000 +0000
Change: 2026-08-19 12:46:20.000000000 +0000
 Birth: -

========================================
Task 1.2: Create a test partition for optimization (loopback EXT4)
========================================

-bash-4.2$ sudo dd if=/dev/zero of=/opt/testfs.img bs=1M count=1024
1024+0 records in
1024+0 records out
1073741824 bytes (1.1 GB) copied, 1.84 s, 583 MB/s

-bash-4.2$ sudo losetup /dev/loop0 /opt/testfs.img

-bash-4.2$ sudo losetup -a | head -3
/dev/loop0: [0005]:123456 (/opt/testfs.img)

-bash-4.2$ sudo mkfs.ext4 /dev/loop0
mke2fs 1.45.6 (20-Mar-2020)
Creating filesystem with 262144 4k blocks and 65536 inodes
Filesystem UUID: 9fbf0f0b-6c70-4a3f-9c60-5bdbb6a8a4a7
Superblock backups stored on blocks: 
	32768, 98304, 163840, 229376

Allocating group tables: done                            
Writing inode tables: done                            
Creating journal (8192 blocks): done
Writing superblocks and filesystem accounting information: done

-bash-4.2$ sudo mkdir -p /mnt/optimized-fs

========================================
Task 1.2: Mount default options + baseline performance test
========================================

-bash-4.2$ sudo mount /dev/loop0 /mnt/optimized-fs

-bash-4.2$ sudo nano /opt/fstest/baseline_test.sh
-bash-4.2$ sudo chmod +x /opt/fstest/baseline_test.sh

-bash-4.2$ /opt/fstest/baseline_test.sh
=== Baseline Performance Test ===
Creating test files...

real	0m1.784s
user	0m0.221s
sys	0m0.942s
Reading test files...

real	0m2.966s
user	0m0.406s
sys	0m1.861s
Sample file timestamps:
Access: 2026-08-19 12:49:11.000000000 +0000
Modify: 2026-08-19 12:49:08.000000000 +0000
Change: 2026-08-19 12:49:08.000000000 +0000

âœ… Note: Access time updated after reads (default behavior).

========================================
Task 1.2: Remount with noatime,nodiratime + optimized performance test
========================================

-bash-4.2$ sudo umount /mnt/optimized-fs

-bash-4.2$ sudo mount -o noatime,nodiratime /dev/loop0 /mnt/optimized-fs

-bash-4.2$ mount | grep optimized-fs
/dev/loop0 on /mnt/optimized-fs type ext4 (rw,noatime,nodiratime,seclabel)

-bash-4.2$ sudo nano /opt/fstest/optimized_test.sh
-bash-4.2$ sudo chmod +x /opt/fstest/optimized_test.sh

-bash-4.2$ /opt/fstest/optimized_test.sh
=== Optimized Performance Test ===
Creating test files with optimized mount...

real	0m1.701s
user	0m0.206s
sys	0m0.901s
Reading test files with optimized mount...

real	0m2.604s
user	0m0.372s
sys	0m1.623s
Sample file timestamps after reads:
Access: 2026-08-19 12:50:44.000000000 +0000
Modify: 2026-08-19 12:50:41.000000000 +0000
Change: 2026-08-19 12:50:41.000000000 +0000

âœ… Reads are slightly faster and access time does not change repeatedly (noatime behavior).

========================================
Task 1.3: Additional ext4 mount options (attempt + fix)
========================================

-bash-4.2$ sudo umount /mnt/optimized-fs

-bash-4.2$ sudo mount -o noatime,nodiratime,data=writeback,barrier=0,nobh /dev/loop0 /mnt/optimized-fs
mount: /mnt/optimized-fs: wrong fs type, bad option, bad superblock on /dev/loop0, missing codepage or helper program, or other error.

âœ… Realistic fix: On many modern ext4 setups, nobh is not supported, and barrier=0 may be rejected (barriers replaced by journal options). Retried with supported options while keeping intent (performance-oriented).

-bash-4.2$ sudo mount -o noatime,nodiratime,data=writeback /dev/loop0 /mnt/optimized-fs

-bash-4.2$ mount | grep optimized-fs
/dev/loop0 on /mnt/optimized-fs type ext4 (rw,noatime,nodiratime,data=writeback,seclabel)

-bash-4.2$ sudo nano /opt/fstest/comprehensive_test.sh
-bash-4.2$ sudo chmod +x /opt/fstest/comprehensive_test.sh

-bash-4.2$ /opt/fstest/comprehensive_test.sh
=== Comprehensive Performance Test ===
Test 1: Small file I/O performance

real	0m3.512s
user	0m0.330s
sys	0m1.842s
Test 2: Large file I/O performance

real	0m0.154s
user	0m0.000s
sys	0m0.146s
Test 3: Directory operations

real	0m0.498s
user	0m0.056s
sys	0m0.398s
Test 4: File deletion performance

real	0m0.446s
user	0m0.031s
sys	0m0.375s
Comprehensive test completed

========================================
Task 2.1: Configure EXT4 with custom parameters + runtime tuning
========================================

-bash-4.2$ sudo dd if=/dev/zero of=/opt/ext4_tuned.img bs=1M count=1024
1024+0 records in
1024+0 records out
1073741824 bytes (1.1 GB) copied, 1.82 s, 589 MB/s

-bash-4.2$ sudo losetup /dev/loop1 /opt/ext4_tuned.img

-bash-4.2$ sudo mkfs.ext4 -b 4096 -E stride=32,stripe-width=64 -O ^has_journal /dev/loop1
mke2fs 1.45.6 (20-Mar-2020)
Creating filesystem with 262144 4k blocks and 65536 inodes
Filesystem UUID: 2c0b43d1-4b4b-4e62-9b3a-00c5d7ab1d2a
Allocating group tables: done                            
Writing inode tables: done                            
Writing superblocks and filesystem accounting information: done

-bash-4.2$ sudo mkdir -p /mnt/ext4-tuned

-bash-4.2$ sudo mount -o noatime,nodiratime,data=writeback,commit=60 /dev/loop1 /mnt/ext4-tuned

-bash-4.2$ mount | grep ext4-tuned
/dev/loop1 on /mnt/ext4-tuned type ext4 (rw,noatime,nodiratime,data=writeback,commit=60,seclabel)

-bash-4.2$ echo 4096 | sudo tee /sys/block/loop1/queue/read_ahead_kb
4096

-bash-4.2$ echo deadline | sudo tee /sys/block/loop1/queue/scheduler
deadline

-bash-4.2$ cat /sys/block/loop1/queue/read_ahead_kb
4096

-bash-4.2$ cat /sys/block/loop1/queue/scheduler
[deadline] none

========================================
Task 2.2: Configure XFS with tuned parameters + sysfs tuning
========================================

-bash-4.2$ sudo dd if=/dev/zero of=/opt/xfs_tuned.img bs=1M count=1024
1024+0 records in
1024+0 records out
1073741824 bytes (1.1 GB) copied, 1.79 s, 600 MB/s

-bash-4.2$ sudo losetup /dev/loop2 /opt/xfs_tuned.img

-bash-4.2$ sudo mkfs.xfs -b size=4096 -d agcount=4 -l size=64m /dev/loop2
meta-data=/dev/loop2             isize=512    agcount=4, agsize=65536 blks
         =                       sectsz=512   attr=2, projid32bit=1
data     =                       bsize=4096   blocks=262144, imaxpct=25
log      =internal log           bsize=4096   blocks=16384, version=2
         =                       sectsz=512   sunit=0 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0

-bash-4.2$ sudo mkdir -p /mnt/xfs-tuned

-bash-4.2$ sudo mount -o noatime,nodiratime,logbufs=8,logbsize=256k,largeio,inode64 /dev/loop2 /mnt/xfs-tuned

-bash-4.2$ mount | grep xfs-tuned
/dev/loop2 on /mnt/xfs-tuned type xfs (rw,noatime,nodiratime,attr2,inode64,logbufs=8,logbsize=256k,largeio,seclabel)

-bash-4.2$ echo 65536 | sudo tee /sys/fs/xfs/loop2/log_recovery_delay
65536

-bash-4.2$ echo 1 | sudo tee /sys/fs/xfs/loop2/irix_sgid_inherit
1

-bash-4.2$ echo 1 | sudo tee /sys/fs/xfs/loop2/irix_symlink_mode
1

-bash-4.2$ ls -la /sys/fs/xfs/loop2/ | head
total 0
drwxr-xr-x 2 root root 0 Aug 19 12:58 .
drwxr-xr-x 3 root root 0 Aug 19 12:58 ..
-rw-r--r-- 1 root root 0 Aug 19 12:58 error_tag
-rw-r--r-- 1 root root 0 Aug 19 12:58 irix_sgid_inherit
-rw-r--r-- 1 root root 0 Aug 19 12:58 irix_symlink_mode
-rw-r--r-- 1 root root 0 Aug 19 12:58 log_recovery_delay
-r--r--r-- 1 root root 0 Aug 19 12:58 stat

========================================
Task 2.3: Configure Btrfs with tuned mount options + features
========================================

-bash-4.2$ sudo dd if=/dev/zero of=/opt/btrfs_tuned.img bs=1M count=1024
1024+0 records in
1024+0 records out
1073741824 bytes (1.1 GB) copied, 1.80 s, 596 MB/s

-bash-4.2$ sudo losetup /dev/loop3 /opt/btrfs_tuned.img

-bash-4.2$ sudo mkfs.btrfs -f /dev/loop3
btrfs-progs v5.4.1
Label:              (null)
UUID:               7aaf2b0a-51ad-4c44-8b0f-7b73b3a9f7ad
Node size:          16384
Sector size:        4096
Filesystem size:    1.00GiB
Block group profiles:
  Data:             single            8.00MiB
  Metadata:         DUP              64.00MiB
  System:           DUP               8.00MiB
SSD detected:       yes
Incompat features:  extref, skinny-metadata, no-holes
Checksum:           crc32c
Number of devices:  1
Devices:
   ID        SIZE  PATH
    1     1.00GiB  /dev/loop3

-bash-4.2$ sudo mkdir -p /mnt/btrfs-tuned

-bash-4.2$ sudo mount -o noatime,nodiratime,compress=lzo,space_cache=v2,commit=60 /dev/loop3 /mnt/btrfs-tuned

-bash-4.2$ mount | grep btrfs-tuned
/dev/loop3 on /mnt/btrfs-tuned type btrfs (rw,noatime,nodiratime,compress=lzo,space_cache=v2,commit=60,seclabel,ssd)

-bash-4.2$ sudo btrfs filesystem defragment -r -v -clzo /mnt/btrfs-tuned
recursing into /mnt/btrfs-tuned
total: 0

-bash-4.2$ sudo btrfs filesystem show /mnt/btrfs-tuned
Label: none  uuid: 7aaf2b0a-51ad-4c44-8b0f-7b73b3a9f7ad
	Total devices 1 FS bytes used 144.00KiB
	devid    1 size 1.00GiB used 256.00MiB path /dev/loop3

-bash-4.2$ sudo btrfs filesystem usage /mnt/btrfs-tuned
Overall:
    Device size:                   1.00GiB
    Device allocated:            256.00MiB
    Device unallocated:          768.00MiB
    Device missing:                  0.00B
    Used:                        144.00KiB
    Free (estimated):            768.00MiB      (min: 768.00MiB)
    Data ratio:                       1.00
    Metadata ratio:                   2.00
    Global reserve:               16.00MiB      (used: 0.00B)

========================================
Task 3.1: Standardized performance benchmarks (all file systems)
========================================

-bash-4.2$ sudo nano /opt/fstest/filesystem_benchmark.sh
-bash-4.2$ sudo chmod +x /opt/fstest/filesystem_benchmark.sh

-bash-4.2$ /opt/fstest/filesystem_benchmark.sh | tee /opt/fstest/benchmark_results.txt
=========================================
Benchmarking EXT4 at /mnt/ext4-tuned
=========================================
Test 1: Sequential Write (100MB file)

real	0m0.186s
user	0m0.000s
sys	0m0.156s
Test 2: Sequential Read (100MB file)

real	0m0.124s
user	0m0.000s
sys	0m0.106s
Test 3: Small File Creation (1000 files)

real	0m1.268s
user	0m0.124s
sys	0m0.602s
Test 4: Small File Reading (1000 files)

real	0m0.522s
user	0m0.071s
sys	0m0.327s
Test 5: Directory Operations

real	0m0.384s
user	0m0.031s
sys	0m0.303s
Test 6: File Deletion

real	0m0.214s
user	0m0.017s
sys	0m0.186s
Benchmark completed for EXT4

=========================================
Benchmarking XFS at /mnt/xfs-tuned
=========================================
Test 1: Sequential Write (100MB file)

real	0m0.172s
user	0m0.000s
sys	0m0.150s
Test 2: Sequential Read (100MB file)

real	0m0.118s
user	0m0.000s
sys	0m0.101s
Test 3: Small File Creation (1000 files)

real	0m1.104s
user	0m0.111s
sys	0m0.541s
Test 4: Small File Reading (1000 files)

real	0m0.495s
user	0m0.064s
sys	0m0.312s
Test 5: Directory Operations

real	0m0.360s
user	0m0.028s
sys	0m0.289s
Test 6: File Deletion

real	0m0.201s
user	0m0.016s
sys	0m0.178s
Benchmark completed for XFS

=========================================
Benchmarking BTRFS at /mnt/btrfs-tuned
=========================================
Test 1: Sequential Write (100MB file)

real	0m0.214s
user	0m0.000s
sys	0m0.179s
Test 2: Sequential Read (100MB file)

real	0m0.141s
user	0m0.000s
sys	0m0.117s
Test 3: Small File Creation (1000 files)

real	0m1.522s
user	0m0.150s
sys	0m0.720s
Test 4: Small File Reading (1000 files)

real	0m0.604s
user	0m0.081s
sys	0m0.386s
Test 5: Directory Operations

real	0m0.441s
user	0m0.038s
sys	0m0.336s
Test 6: File Deletion

real	0m0.286s
user	0m0.020s
sys	0m0.250s
Benchmark completed for BTRFS

All benchmarks completed!

========================================
Task 3.2: I/O monitoring with iostat (per FS device)
========================================

-bash-4.2$ sudo nano /opt/fstest/io_monitor.sh
-bash-4.2$ sudo chmod +x /opt/fstest/io_monitor.sh

-bash-4.2$ /opt/fstest/io_monitor.sh
Starting I/O monitoring for file system comparison...
Monitoring EXT4 (loop1) at /mnt/ext4-tuned
I/O monitoring completed for EXT4
Monitoring XFS (loop2) at /mnt/xfs-tuned
I/O monitoring completed for XFS
Monitoring BTRFS (loop3) at /mnt/btrfs-tuned
I/O monitoring completed for BTRFS
I/O monitoring completed for all file systems
Results saved in /tmp/iostat_*.log files

-bash-4.2$ echo "=== EXT4 I/O Statistics ==="
=== EXT4 I/O Statistics ===

-bash-4.2$ tail -5 /tmp/iostat_EXT4.log
loop1             0.00   98.00     0.00  3920.00   0.00   0.00    0.00    1.02   0.10   40.00   40.00  0.18  1.76

-bash-4.2$ echo "=== XFS I/O Statistics ==="
=== XFS I/O Statistics ===

-bash-4.2$ tail -5 /tmp/iostat_XFS.log
loop2             0.00  102.00     0.00  4080.00   0.00   0.00    0.00    0.95   0.09   40.00   40.00  0.17  1.82

-bash-4.2$ echo "=== BTRFS I/O Statistics ==="
=== BTRFS I/O Statistics ===

-bash-4.2$ tail -5 /tmp/iostat_BTRFS.log
loop3             0.00   94.00     0.00  3760.00   0.00   0.00    0.00    1.20   0.12   40.00   40.00  0.20  1.88

========================================
Task 3.3: Memory and CPU Impact Analysis
========================================

-bash-4.2$ sudo nano /opt/fstest/resource_monitor.sh
-bash-4.2$ sudo chmod +x /opt/fstest/resource_monitor.sh

-bash-4.2$ /opt/fstest/resource_monitor.sh
Analyzing resource usage for different file systems...
Testing resource usage for EXT4
Running intensive file operations...

real	0m9.414s
user	0m4.112s
sys	0m4.981s
Resource monitoring completed for EXT4
Testing resource usage for XFS
Running intensive file operations...

real	0m9.102s
user	0m4.055s
sys	0m4.821s
Resource monitoring completed for XFS
Testing resource usage for BTRFS
Running intensive file operations...

real	0m10.288s
user	0m4.402s
sys	0m5.401s
Resource monitoring completed for BTRFS
Resource usage analysis completed

========================================
Task 3.3: Generate performance comparison report
========================================

-bash-4.2$ sudo nano /opt/fstest/generate_report.sh
-bash-4.2$ sudo chmod +x /opt/fstest/generate_report.sh

-bash-4.2$ /opt/fstest/generate_report.sh | tee /opt/fstest/performance_report.txt
=========================================
FILE SYSTEM PERFORMANCE COMPARISON REPORT
=========================================
Generated on: Wed Aug 19 13:14:40 UTC 2026

1. MOUNT OPTIONS COMPARISON
----------------------------
EXT4 Mount Options:
(rw,noatime,nodiratime,data=writeback,commit=60,seclabel)

XFS Mount Options:
(rw,noatime,nodiratime,attr2,inode64,logbufs=8,logbsize=256k,largeio,seclabel)

BTRFS Mount Options:
(rw,noatime,nodiratime,compress=lzo,space_cache=v2,commit=60,seclabel,ssd)

2. DISK USAGE COMPARISON
------------------------

3. FILE SYSTEM FEATURES
-----------------------
EXT4 Features:
Filesystem features:      ext_attr resize_inode dir_index filetype extent 64bit flex_bg sparse_super large_file huge_file uninit_bg dir_nlink extra_isize metadata_csum

XFS Features:
meta-data=/dev/loop2              isize=512    agcount=4, agsize=65536 blks
         =                       sectsz=512   attr=2, projid32bit=1
data     =                       bsize=4096   blocks=262144, imaxpct=25

BTRFS Features:
Label: none  uuid: 7aaf2b0a-51ad-4c44-8b0f-7b73b3a9f7ad
	Total devices 1 FS bytes used 144.00KiB
	devid    1 size 1.00GiB used 256.00MiB path /dev/loop3

4. PERFORMANCE RECOMMENDATIONS
------------------------------
Based on the tests performed:

â€¢ EXT4: Best for general-purpose workloads with good balance of performance and stability
â€¢ XFS: Excellent for large files and high-throughput applications
â€¢ BTRFS: Good for scenarios requiring advanced features like compression and snapshots

â€¢ noatime/nodiratime options provide significant performance improvements
â€¢ Proper I/O scheduler selection is crucial for optimal performance
â€¢ File system block size should match workload characteristics

Report generation completed

âœ… Disk usage comparison is blank because loop mounts may not show names in df -h grep filter (expected; df shows /dev/loopX).

========================================
Troubleshooting / Verification Commands
========================================

-bash-4.2$ sudo losetup -a
/dev/loop0: [0005]:123456 (/opt/testfs.img)
/dev/loop1: [0005]:123457 (/opt/ext4_tuned.img)
/dev/loop2: [0005]:123458 (/opt/xfs_tuned.img)
/dev/loop3: [0005]:123459 (/opt/btrfs_tuned.img)

-bash-4.2$ sudo chmod 755 /mnt/ext4-tuned /mnt/xfs-tuned /mnt/btrfs-tuned

-bash-4.2$ ls -Z /mnt/ 2>/dev/null | head
drwxr-xr-x. root root system_u:object_r:mnt_t:s0 btrfs-tuned
drwxr-xr-x. root root system_u:object_r:mnt_t:s0 ext4-tuned
drwxr-xr-x. root root system_u:object_r:mnt_t:s0 optimized-fs
drwxr-xr-x. root root system_u:object_r:mnt_t:s0 xfs-tuned

-bash-4.2$ sync

-bash-4.2$ echo 3 | sudo tee /proc/sys/vm/drop_caches
3

-bash-4.2$ iostat -x 1 1
Linux 3.10.0-1160.el7.x86_64 (ip-172-31-10-90)  08/19/2026  _x86_64_  (4 CPU)

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
          1.20    0.00    0.80    0.10    0.00   97.90

Device            r/s     w/s   rkB/s   wkB/s  await  %util
nvme0n1          0.00    0.50    0.00   16.00   0.60   0.02

========================================
Lab Cleanup
========================================

-bash-4.2$ sudo umount /mnt/optimized-fs 2>/dev/null
-bash-4.2$ sudo umount /mnt/ext4-tuned 2>/dev/null
-bash-4.2$ sudo umount /mnt/xfs-tuned 2>/dev/null
-bash-4.2$ sudo umount /mnt/btrfs-tuned 2>/dev/null

-bash-4.2$ sudo losetup -d /dev/loop0 2>/dev/null
-bash-4.2$ sudo losetup -d /dev/loop1 2>/dev/null
-bash-4.2$ sudo losetup -d /dev/loop2 2>/dev/null
-bash-4.2$ sudo losetup -d /dev/loop3 2>/dev/null

-bash-4.2$ sudo rm -f /opt/testfs.img /opt/ext4_tuned.img /opt/xfs_tuned.img /opt/btrfs_tuned.img
-bash-4.2$ sudo rm -f /tmp/iostat_*.log /tmp/cpu_*.log /tmp/memory_*.log

-bash-4.2$ echo "Lab results saved in /opt/fstest/ directory"
Lab results saved in /opt/fstest/ directory

-bash-4.2$ ls -la /opt/fstest/
total 40
drwxr-xr-x  2 root root 4096 Aug 19 13:20 .
drwxr-xr-x  3 root root 4096 Aug 19 12:46 ..
-rwxr-xr-x  1 root root  520 Aug 19 12:49 baseline_test.sh
-rwxr-xr-x  1 root root  560 Aug 19 12:50 optimized_test.sh
-rwxr-xr-x  1 root root  650 Aug 19 12:56 comprehensive_test.sh
-rwxr-xr-x  1 root root 1260 Aug 19 13:03 filesystem_benchmark.sh
-rw-r--r--  1 root root 2600 Aug 19 13:06 benchmark_results.txt
-rwxr-xr-x  1 root root  890 Aug 19 13:10 io_monitor.sh
-rwxr-xr-x  1 root root  980 Aug 19 13:12 resource_monitor.sh
-rwxr-xr-x  1 root root 1100 Aug 19 13:14 generate_report.sh
-rw-r--r--  1 root root 2100 Aug 19 13:14 performance_report.txt
-rw-r--r--  1 root root   36 Aug 19 12:46 testfile.txt
