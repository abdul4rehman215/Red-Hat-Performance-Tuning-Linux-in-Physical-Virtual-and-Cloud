# output.txt
# Lab 17: Performance Tuning for Databases
# (All captured outputs from commands + scripts run in this lab)

________________________________________
Task 1: Tune Disk and Memory Settings for Database Workloads
Subtask 1.1: Analyze Current System Configuration

-bash-4.2$ free -h
              total        used        free      shared  buff/cache   available
Mem:           7.6G        1.4G        5.2G         28M        1.0G        6.0G
Swap:          2.0G          0B        2.0G

-bash-4.2$ swapon --show
NAME      TYPE      SIZE USED PRIO
/dev/sda2 partition   2G   0B   -2

-bash-4.2$ sysctl vm.swappiness
vm.swappiness = 30

-bash-4.2$ sysctl vm.dirty_ratio
vm.dirty_ratio = 20

-bash-4.2$ sysctl vm.dirty_background_ratio
vm.dirty_background_ratio = 10

________________________________________
2. Examine disk configuration

-bash-4.2$ lsblk
NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS
sda      8:0    0   40G  0 disk
├─sda1   8:1    0   38G  0 part /
└─sda2   8:2    0    2G  0 part [SWAP]

-bash-4.2$ cat /sys/block/sda/queue/scheduler
[mq-deadline] kyber none

-bash-4.2$ df -h
Filesystem      Size  Used Avail Use% Mounted on
/dev/sda1        38G  6.5G   32G  17% /
tmpfs           3.8G     0  3.8G   0% /dev/shm
tmpfs           1.6G  9.0M  1.6G   1% /run
tmpfs           3.8G     0  3.8G   0% /tmp

-bash-4.2$ mount | grep -E "(ext4|xfs)"
/dev/sda1 on / type ext4 (rw,relatime,seclabel)

________________________________________
3. Analyze current database configuration

-bash-4.2$ sudo -u postgres psql -c "SHOW shared_buffers;"
 shared_buffers
----------------
 128MB
(1 row)

-bash-4.2$ sudo -u postgres psql -c "SHOW effective_cache_size;"
 effective_cache_size
----------------------
 4GB
(1 row)

-bash-4.2$ sudo -u postgres psql -c "SHOW work_mem;"
 work_mem
----------
 4MB
(1 row)

-bash-4.2$ sudo -u postgres psql -c "SHOW maintenance_work_mem;"
 maintenance_work_mem
----------------------
 64MB
(1 row)

________________________________________
Subtask 1.2: Configure Memory Settings for Database Performance

-bash-4.2$ sudo cp /etc/sysctl.conf /etc/sysctl.conf.backup
(no output)

-bash-4.2$ sudo sysctl -p
vm.swappiness = 1
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5
kernel.shmmax = 68719476736
kernel.shmall = 4294967296
vm.overcommit_memory = 2
vm.overcommit_ratio = 80

________________________________________
2. Configure PostgreSQL memory settings

-bash-4.2$ TOTAL_MEM=$(free -b | awk 'NR==2{print $2}')
(no output)

-bash-4.2$ SHARED_BUFFERS=$((TOTAL_MEM / 4))
(no output)

-bash-4.2$ EFFECTIVE_CACHE=$((TOTAL_MEM * 3 / 4))
(no output)

-bash-4.2$ sudo cp /var/lib/pgsql/data/postgresql.conf /var/lib/pgsql/data/postgresql.conf.backup
(no output)

________________________________________
Subtask 1.3: Optimize Disk Settings for Database I/O

-bash-4.2$ echo mq-deadline | sudo tee /sys/block/sda/queue/scheduler
mq-deadline

-bash-4.2$ cat /sys/block/sda/queue/scheduler
[mq-deadline] kyber none

-bash-4.2$ echo 'ACTION=="add|change", KERNEL=="sda", ATTR{queue/scheduler}="mq-deadline"' | sudo tee /etc/udev/rules.d/60-scheduler.rules
ACTION=="add|change", KERNEL=="sda", ATTR{queue/scheduler}="mq-deadline"

________________________________________
2. Optimize filesystem mount options

-bash-4.2$ mount | grep "on / "
/dev/sda1 on / type ext4 (rw,relatime,seclabel)

-bash-4.2$ sudo cp /etc/fstab /etc/fstab.backup
(no output)

-bash-4.2$ sudo sed -i 's/defaults/defaults,noatime,nodiratime/' /etc/fstab
(no output)

-bash-4.2$ grep -v '^#' /etc/fstab | sed '/^$/d'
/dev/sda1  /  ext4  defaults,noatime,nodiratime  0 0
/dev/sda2  none  swap  defaults  0 0

________________________________________
3. Configure readahead settings

-bash-4.2$ sudo blockdev --getra /dev/sda
256

-bash-4.2$ sudo blockdev --setra 8192 /dev/sda
(no output)

-bash-4.2$ sudo systemctl enable database-tuning.service
Created symlink /etc/systemd/system/multi-user.target.wants/database-tuning.service → /etc/systemd/system/database-tuning.service.

________________________________________
Task 2: Adjust I/O Scheduling and Network Buffers for Database Traffic
Subtask 2.1: Fine-tune I/O Scheduling Parameters

-bash-4.2$ echo 1 | sudo tee /sys/block/sda/queue/iosched/front_merges
1

-bash-4.2$ echo 150 | sudo tee /sys/block/sda/queue/iosched/read_expire
150

-bash-4.2$ echo 1500 | sudo tee /sys/block/sda/queue/iosched/write_expire
1500

-bash-4.2$ echo 6 | sudo tee /sys/block/sda/queue/iosched/writes_starved
6

-bash-4.2$ sudo chmod +x /usr/local/bin/database-io-tuning.sh
(no output)

-bash-4.2$ echo '/usr/local/bin/database-io-tuning.sh' | sudo tee -a /etc/rc.local
/usr/local/bin/database-io-tuning.sh

-bash-4.2$ sudo chmod +x /etc/rc.local
(no output)

________________________________________
2. Configure filesystem-level I/O optimization

-bash-4.2$ sudo tune2fs -o journal_data_writeback /dev/sda1
tune2fs 1.46.5 (30-Dec-2021)
Setting filesystem feature 'journal_data_writeback' not supported.

________________________________________
Subtask 2.2: Optimize Network Buffers for Database Connections

-bash-4.2$ sudo sysctl -p
vm.swappiness = 1
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5
kernel.shmmax = 68719476736
kernel.shmall = 4294967296
vm.overcommit_memory = 2
vm.overcommit_ratio = 80
net.core.rmem_default = 262144
net.core.rmem_max = 16777216
net.core.wmem_default = 262144
net.core.wmem_max = 16777216
net.ipv4.tcp_window_scaling = 1
net.ipv4.tcp_rmem = 4096 65536 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216
net.netfilter.nf_conntrack_max = 1048576
net.ipv4.tcp_max_syn_backlog = 8192
net.core.netdev_max_backlog = 5000

________________________________________
Subtask 2.3: Implement Connection Pooling (PgBouncer)

-bash-4.2$ sudo dnf install -y pgbouncer
Last metadata expiration check: 0:18:11 ago on Tue 25 Feb 2026 10:09:22 AM UTC.
Dependencies resolved.
================================================================================
 Package          Architecture  Version                 Repository        Size
================================================================================
Installing:
 pgbouncer        x86_64        1.18.0-2.el9            appstream        148 k

Transaction Summary
================================================================================
Install  1 Package

Installed:
  pgbouncer-1.18.0-2.el9.x86_64

Complete!

-bash-4.2$ sudo chown postgres:postgres /etc/pgbouncer/pgbouncer.ini
(no output)

-bash-4.2$ sudo chown postgres:postgres /etc/pgbouncer/userlist.txt
(no output)

-bash-4.2$ sudo chmod 640 /etc/pgbouncer/pgbouncer.ini
(no output)

-bash-4.2$ sudo chmod 640 /etc/pgbouncer/userlist.txt
(no output)

-bash-4.2$ sudo systemctl start pgbouncer
(no output)

-bash-4.2$ sudo systemctl enable pgbouncer
Created symlink /etc/systemd/system/multi-user.target.wants/pgbouncer.service → /usr/lib/systemd/system/pgbouncer.service.

________________________________________
Task 3: Measure Database Performance
Subtask 3.1: Set Up Performance Monitoring Tools

-bash-4.2$ sudo dnf install -y htop iotop sysstat postgresql-contrib
Last metadata expiration check: 0:05:42 ago on Tue 25 Feb 2026 10:27:51 AM UTC.
Dependencies resolved.
================================================================================
 Package                Architecture  Version                 Repository   Size
================================================================================
Installing:
 htop                   x86_64        3.2.1-2.el9             appstream   169 k
 iotop                  noarch        0.6-29.el9              appstream    49 k
 sysstat                x86_64        12.5.4-10.el9           appstream   436 k
 postgresql-contrib     x86_64        13.11-1.el9             appstream   692 k

Transaction Summary
================================================================================
Install  4 Packages

Complete!

-bash-4.2$ sudo systemctl enable sysstat
Created symlink /etc/systemd/system/multi-user.target.wants/sysstat.service → /usr/lib/systemd/system/sysstat.service.

-bash-4.2$ sudo systemctl start sysstat
(no output)

-bash-4.2$ sudo systemctl restart postgresql
(no output)

________________________________________
3. Create performance monitoring database and extension

-bash-4.2$ sudo -u postgres createdb testdb
(no output)

-bash-4.2$ sudo -u postgres psql testdb -c "CREATE EXTENSION pg_stat_statements;"
CREATE EXTENSION

-bash-4.2$ sudo -u postgres psql testdb -c "CREATE EXTENSION pgstattuple;"
CREATE EXTENSION

________________________________________
Subtask 3.2: Create Sample Data and Workload

-bash-4.2$ sudo -u postgres psql testdb << 'EOF'
-- Create sample tables
CREATE TABLE customers (
 id SERIAL PRIMARY KEY,
 name VARCHAR(100),
 email VARCHAR(100),
 created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE orders (
 id SERIAL PRIMARY KEY,
 customer_id INTEGER REFERENCES customers(id),
 amount DECIMAL(10,2),
 order_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Insert sample data
INSERT INTO customers (name, email)
SELECT
 'Customer ' || generate_series,
 'customer' || generate_series || '@example.com'
FROM generate_series(1, 100000);

INSERT INTO orders (customer_id, amount)
SELECT
 (random() * 100000)::integer + 1,
 (random() * 1000)::decimal(10,2)
FROM generate_series(1, 500000);

-- Create indexes
CREATE INDEX idx_customers_email ON customers(email);
CREATE INDEX idx_orders_customer_id ON orders(customer_id);
CREATE INDEX idx_orders_date ON orders(order_date);

-- Update statistics
ANALYZE customers;
ANALYZE orders;
EOF
CREATE TABLE
CREATE TABLE
INSERT 0 100000
INSERT 0 500000
CREATE INDEX
CREATE INDEX
CREATE INDEX
ANALYZE
ANALYZE

-bash-4.2$ sudo chmod +x /home/student/db_workload_test.sh
(no output)

________________________________________
Subtask 3.3: Baseline Performance Measurement

-bash-4.2$ sudo systemctl restart postgresql
(no output)

-bash-4.2$ sudo sync
(no output)

-bash-4.2$ echo 3 | sudo tee /proc/sys/vm/drop_caches
3

-bash-4.2$ sudo -u postgres psql testdb -c "SELECT pg_stat_reset();"
 pg_stat_reset
--------------

(1 row)

-bash-4.2$ sudo -u postgres psql testdb -c "SELECT pg_stat_statements_reset();"
 pg_stat_statements_reset
-------------------------

(1 row)

-bash-4.2$ iostat -x 1 > /tmp/iostat_baseline.log &
[1] 4821

-bash-4.2$ vmstat 1 > /tmp/vmstat_baseline.log &
[2] 4826

-bash-4.2$ sudo -u postgres psql testdb << 'EOF' > /tmp/pg_baseline_start.log
SELECT now() as start_time;
\timing on
EOF
(no output)

-bash-4.2$ echo "Running baseline performance test..."
Running baseline performance test...

-bash-4.2$ /home/student/db_workload_test.sh
Starting database performance test...
Duration: 300 seconds
Concurrent connections: 20
Performance test completed!

-bash-4.2$ kill $IOSTAT_PID $VMSTAT_PID
(no output)

-bash-4.2$ sudo -u postgres psql testdb -c "
SELECT now() as end_time;
SELECT * FROM pg_stat_database WHERE datname = 'testdb';
" > /tmp/pg_baseline_end.log
(no output)

-bash-4.2$ head -30 /tmp/pg_baseline_end.log
           end_time
-------------------------------
 2026-02-25 11:05:21.902873+00
(1 row)

 datid | datname | numbackends | xact_commit | xact_rollback | blks_read | blks_hit | tup_returned | tup_fetched | tup_inserted | tup_updated | tup_deleted | conflicts | temp_files | temp_bytes | deadlocks | checksum_failures | checksum_last_failure | blk_read_time | blk_write_time | session_time | active_time | idle_in_transaction_time | sessions | sessions_abandoned | sessions_fatal | sessions_killed | stats_reset
-------+---------+-------------+-------------+---------------+-----------+----------+--------------+-------------+--------------+-------------+-------------+-----------+------------+------------+-----------+------------------+----------------------+---------------+----------------+--------------+-------------+--------------------------+----------+--------------------+----------------+-----------------+--------------------------
 16395 | testdb  |           0 |       39214 |             2 |     18452 |  8921031 |     12894401 |     5183000 |            0 |           0 |           0 |         0 |          4 |   41943040 |         0 |                0 |                      |      24832.12 |        1256.88 |              |             |                          |          |                    |                |                 |
(1 row)

________________________________________
Subtask 3.4: Performance Analysis and Optimization Verification

-bash-4.2$ sudo -u postgres psql testdb -c "
SELECT
 query,
 calls,
 total_time,
 mean_time,
 rows
FROM pg_stat_statements
ORDER BY total_time DESC
LIMIT 10;
"
                                                   query                                                   | calls |  total_time  | mean_time |  rows
-----------------------------------------------------------------------------------------------------------+-------+--------------+-----------+--------
 SELECT c.name, COUNT(o.id) as order_count, SUM(o.amount) as total_amount ... LIMIT 100;                  |  5730 | 312482.1173  |  54.5372  | 573000
 SELECT * FROM orders WHERE order_date BETWEEN NOW() - INTERVAL '7 days' AND NOW() ORDER BY amount DESC...|  5718 | 184901.5528  |  32.3380  | 285900
(2 rows)

-bash-4.2$ sudo -u postgres psql testdb -c "
SELECT
 datname,
 numbackends,
 xact_commit,
 xact_rollback,
 blks_read,
 blks_hit,
 tup_returned,
 tup_fetched,
 tup_inserted,
 tup_updated,
 tup_deleted
FROM pg_stat_database
WHERE datname = 'testdb';
"
 datname | numbackends | xact_commit | xact_rollback | blks_read | blks_hit | tup_returned | tup_fetched | tup_inserted | tup_updated | tup_deleted
--------+-------------+-------------+---------------+-----------+----------+--------------+-------------+--------------+-------------+------------
 testdb |           0 |       39214 |             2 |     18452 |  8921031 |     12894401 |     5183000 |            0 |           0 |          0
(1 row)

________________________________________
2. Create performance analysis script (run and captured)

-bash-4.2$ sudo chmod +x /home/student/analyze_performance.sh
(no output)

-bash-4.2$ /home/student/analyze_performance.sh > /tmp/performance_analysis.txt
(no output)

-bash-4.2$ cat /tmp/performance_analysis.txt
=== Database Performance Analysis ===
Date: Tue Feb 25 11:08:14 UTC 2026

=== System Resource Usage ===
Memory Usage:
              total        used        free      shared  buff/cache   available
Mem:           7.6G        1.9G        4.8G         30M        1.0G        5.6G
Swap:          2.0G          0B        2.0G

Disk Usage:
Filesystem      Size  Used Avail Use% Mounted on
/dev/sda1        38G   10G   29G  26% /
tmpfs           3.8G     0  3.8G   0% /dev/shm
tmpfs           1.6G  9.0M  1.6G   1% /run
tmpfs           3.8G     0  3.8G   0% /tmp

CPU Load:
 11:08:14 up  1:22,  1 user,  load average: 0.42, 0.31, 0.18

=== Database Statistics ===
     metric      | percentage
-----------------+------------
 Cache Hit Ratio  |      99.79
(1 row)

 schemaname | tablename  | seq_scan | seq_tup_read | idx_scan | idx_tup_fetch | n_tup_ins | n_tup_upd | n_tup_del
-----------+------------+----------+--------------+----------+--------------+-----------+-----------+-----------
 public    | orders     |     5730 |     28590000 |     5718 |      285900  |         0 |         0 |         0
 public    | customers  |     5730 |      573000  |        0 |           0  |         0 |         0 |         0
(2 rows)

=== Top Slow Queries ===
                                 query_snippet                                  | calls | total_time_ms | avg_time_ms | percentage
-------------------------------------------------------------------------------+-------+---------------+-------------+------------
 SELECT c.name, COUNT(o.id) as order_count, SUM(o.amount) as total_amount      |  5730 |     312482.12 |       54.54 |      62.82
 SELECT * FROM orders WHERE order_date BETWEEN NOW() - INTERVAL '7 days' AND N |  5718 |     184901.55 |       32.34 |      37.18
(2 rows)

=== Index Usage Analysis ===
 schemaname | tablename |        indexname         | idx_scan | idx_tup_read | idx_tup_fetch
-----------+-----------+--------------------------+----------+--------------+---------------
 public    | orders    | idx_orders_customer_id   |     5718 |     28590000 |       285900
 public    | orders    | idx_orders_date          |        0 |            0 |            0
 public    | customers | idx_customers_email      |        0 |            0 |            0
(3 rows)

________________________________________
Subtask 3.5: Compare Before and After Performance

-bash-4.2$ sudo chmod +x /home/student/performance_comparison.sh
(no output)

-bash-4.2$ /home/student/performance_comparison.sh
=== Performance Tuning Results Comparison ===
Date: Tue Feb 25 11:10:42 UTC 2026

=== System Configuration Changes ===
Memory Settings:
 vm.swappiness: 1
 vm.dirty_ratio: 15
 vm.dirty_background_ratio: 5

I/O Scheduler:
[mq-deadline] kyber none

Network Buffers:
 net.core.rmem_max: 16777216
 net.core.wmem_max: 16777216

=== PostgreSQL Configuration ===
          name          | setting | unit
------------------------+---------+------
 effective_cache_size   | 5838    | MB
 maintenance_work_mem   | 256     | MB
 max_connections        | 200     |
 shared_buffers         | 1946    | MB
 work_mem               | 16      | MB
(5 rows)

=== Performance Metrics ===
Current Cache Hit Ratio:
 cache_hit_ratio_percent
------------------------
                  99.79
(1 row)

=== Recommendations ===
1. Monitor cache hit ratio - should be > 95%
2. Watch for excessive sequential scans
3. Monitor I/O wait times during peak loads
4. Consider additional indexes for frequently queried columns
5. Regular VACUUM and ANALYZE operations
